<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>사진기록</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            touch-action: manipulation; 
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- [핵심] IndexedDB 관리 함수 ---
        const DB_NAME = 'PhotoLogDB';
        const STORE_NAME = 'photos';
        const DB_VERSION = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("Database error: " + event.target.errorCode);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: "date" });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
            });
        };

        const saveToDB = async (dateKey, imageData) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ date: dateKey, image: imageData });
                request.onsuccess = () => resolve(true);
                request.onerror = () => reject("Save failed");
            });
        };

        const loadFromDB = async () => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readonly");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const photosObj = {};
                    request.result.forEach(item => {
                        photosObj[item.date] = item.image;
                    });
                    resolve(photosObj);
                };
                request.onerror = () => reject("Load failed");
            });
        };

        const deleteFromDB = async (dateKey) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(dateKey);
                request.onsuccess = () => resolve(true);
                request.onerror = () => reject("Delete failed");
            });
        };

        // --- 이미지 압축 유틸리티 ---
        const compressImage = (file, maxWidth = 1920, quality = 0.9) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        };

        // --- 유틸리티 함수 ---
        const generateCalendar = (year, month) => {
            const startDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calendar = [];
            let week = Array(startDay).fill(null);

            for (let day = 1; day <= daysInMonth; day++) {
                week.push(day);
                if (week.length === 7) {
                    calendar.push(week);
                    week = [];
                }
            }
            if (week.length > 0) {
                while (week.length < 7) week.push(null);
                calendar.push(week);
            }
            return calendar;
        };

        const formatDateKey = (year, month, day) => {
            if (!day) return null;
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        };

        // --- 메인 컴포넌트 ---
        function App() {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date().getDate());
            const [photos, setPhotos] = useState({}); 
            const [viewMode, setViewMode] = useState('calendar'); 
            const [compareMode, setCompareMode] = useState('gallery'); 
            const [splitSelection, setSplitSelection] = useState([null, null]); 
            const [loading, setLoading] = useState(true);
            
            const scrollRef = useRef(null);

            const today = new Date();
            const isToday = (day) => {
                return day === today.getDate() && 
                    currentDate.getMonth() === today.getMonth() && 
                    currentDate.getFullYear() === today.getFullYear();
            };

            useEffect(() => {
                const loadData = async () => {
                    try {
                        const savedPhotos = await loadFromDB();
                        setPhotos(savedPhotos);
                    } catch (e) {
                        console.error("데이터베이스 로드 실패", e);
                    } finally {
                        setLoading(false);
                    }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (viewMode === 'compare' && compareMode === 'gallery' && scrollRef.current) {
                    setTimeout(() => {
                        if (scrollRef.current) {
                            scrollRef.current.scrollLeft = scrollRef.current.scrollWidth;
                        }
                    }, 0);
                }
            }, [viewMode, compareMode]);

            const handlePhotoUpload = async (e) => {
                const file = e.target.files[0];
                if (!file || !selectedDate) return;

                try {
                    const compressedDataUrl = await compressImage(file);
                    const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDate);
                    await saveToDB(dateKey, compressedDataUrl);
                    setPhotos(prev => ({ ...prev, [dateKey]: compressedDataUrl }));
                } catch (error) {
                    alert("사진 저장 중 오류가 발생했습니다: " + error);
                }
            };

            const handleDeletePhoto = async () => {
                if (!selectedDate) return;
                const dateKey = formatDateKey(currentDate.getFullYear(), currentDate.getMonth(), selectedDate);
                try {
                    await deleteFromDB(dateKey);
                    const newPhotos = { ...photos };
                    delete newPhotos[dateKey];
                    setPhotos(newPhotos);
                } catch (error) {
                    console.error("삭제 실패", error);
                }
            };

            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const calendarData = generateCalendar(year, month);
            const selectedDateKey = formatDateKey(year, month, selectedDate);
            const hasPhotoToday = selectedDate && photos[selectedDateKey];
            const sortedPhotoDates = Object.keys(photos).sort();
            
            const gallerySortedDates = sortedPhotoDates; 

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-gray-400">데이터 로딩 중...</div>;

            return (
                <div className="flex flex-col h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
                
                {/* 헤더 */}
                <header className="flex items-center justify-between px-5 py-4 bg-white border-b border-gray-100 z-20 shrink-0 select-none shadow-sm">
                    <h1 className="text-xl font-extrabold text-gray-900 tracking-tight flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2.5} stroke="currentColor" className="w-6 h-6 text-black">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                        사진기록
                    </h1>
                    {viewMode === 'calendar' && (
                    <button 
                        onClick={() => setViewMode('compare')}
                        /* 진한 파랑 유지 */
                        className="text-sm font-bold text-white bg-blue-800 px-5 py-2.5 rounded-full active:bg-blue-900 transition-colors shadow-md hover:bg-blue-700"
                    >
                        비교하기
                    </button>
                    )}
                    {viewMode === 'compare' && (
                    <button 
                        onClick={() => setViewMode('calendar')}
                        className="text-sm font-bold text-gray-600 bg-gray-100 px-4 py-2 rounded-full active:bg-gray-200"
                    >
                        달력보기
                    </button>
                    )}
                </header>

                <main className="flex-1 overflow-y-auto scroll-smooth">
                    
                    {/* 달력 모드 */}
                    {viewMode === 'calendar' && (
                    <div className="flex flex-col min-h-full pb-10">
                        {/* 달력 박스 */}
                        <div className="px-4 py-4 z-10">
                            <div className="bg-white rounded-3xl border border-gray-200 shadow-sm p-4 pb-6">
                                <div className="flex items-center justify-center gap-8 py-2 select-none mb-2">
                                    <button onClick={prevMonth} className="text-gray-400 hover:text-black font-bold text-2xl p-2">&lt;</button>
                                    <span className="text-xl font-extrabold text-gray-900">{year}년 {month + 1}월</span>
                                    <button onClick={nextMonth} className="text-gray-400 hover:text-black font-bold text-2xl p-2">&gt;</button>
                                </div>
                                
                                <div className="grid grid-cols-7 text-center mb-3 text-sm font-bold select-none text-gray-400">
                                    {['일', '월', '화', '수', '목', '금', '토'].map((day, idx) => (
                                        <div key={day} className={`py-1 ${idx === 0 ? 'text-red-500' : idx === 6 ? 'text-blue-500' : ''}`}>
                                            {day}
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="w-full">
                                    {calendarData.map((week, i) => (
                                    <div key={i} className="grid grid-cols-7 mb-2 gap-y-1">
                                        {week.map((day, j) => {
                                        const dateKey = formatDateKey(year, month, day);
                                        const isPhoto = dateKey && photos[dateKey];
                                        const isSelected = day === selectedDate;
                                        const isTodayDate = day && isToday(day);
                                        
                                        let textColor = 'text-gray-800';
                                        if (j === 0) textColor = 'text-red-500'; 
                                        else if (j === 6) textColor = 'text-blue-500'; 

                                        return (
                                            <div key={j} className="flex flex-col items-center justify-center h-10 sm:h-12 relative">
                                            {day && (
                                                <button onClick={() => setSelectedDate(day)} className="w-full h-full flex items-center justify-center relative group">
                                                <div className={`
                                                    w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center rounded-full text-base font-bold transition-all relative z-10 
                                                    ${isTodayDate 
                                                        ? 'bg-purple-600 text-white' 
                                                        : isPhoto 
                                                            ? 'bg-green-500 text-white' 
                                                            : textColor
                                                    } 
                                                    ${isSelected && !isTodayDate && !isPhoto ? 'bg-gray-100 ring-1 ring-gray-300' : ''} 
                                                    ${isSelected && (isTodayDate || isPhoto) ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''}
                                                `}>
                                                    {day}
                                                </div>
                                                {isTodayDate && <span className="absolute -bottom-1 text-[9px] text-purple-600 font-extrabold z-20 bg-white px-1 rounded-full leading-none">오늘</span>}
                                                </button>
                                            )}
                                            </div>
                                        );
                                        })}
                                    </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 bg-gray-50 p-0">
                        {selectedDate ? (
                            <div className="flex flex-col w-full min-h-[50vh]">
                                <div className="px-6 py-2 flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-gray-900">{month + 1}월 {selectedDate}일</h3>
                                </div>
                                {hasPhotoToday ? (
                                    <div className="flex flex-col gap-0 px-4">
                                        <div className="w-full bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 relative">
                                            <img src={photos[selectedDateKey]} alt="기록" className="w-full h-auto block" />
                                        </div>
                                        <div className="flex gap-3 shrink-0 py-6">
                                            <label className="flex-1 bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold text-sm flex items-center justify-center cursor-pointer active:bg-gray-50 transition-colors shadow-sm">
                                                사진 교체
                                                <input type="file" accept="image/*" className="hidden" onChange={handlePhotoUpload} />
                                            </label>
                                            <button onClick={handleDeletePhoto} className="flex-1 bg-red-50 border border-red-100 text-red-500 py-3 rounded-xl font-bold text-sm flex items-center justify-center active:bg-red-100 transition-colors shadow-sm">삭제</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col justify-start gap-4 py-2 px-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            {/* [수정] 묵직한 색(slate-900) 대신 선명한 파랑(bg-blue-500) 적용 */}
                                            <label className="flex flex-col items-center justify-center gap-1 bg-blue-500 hover:bg-blue-400 active:bg-blue-600 rounded-2xl p-4 cursor-pointer transition-all shadow-md h-24 sm:h-28">
                                                <div className="font-extrabold text-white text-xl">촬영</div>
                                                <div className="text-blue-100 text-xs">Camera</div>
                                                <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handlePhotoUpload} />
                                            </label>
                                            <label className="flex flex-col items-center justify-center gap-1 bg-blue-500 hover:bg-blue-400 active:bg-blue-600 rounded-2xl p-4 cursor-pointer transition-all shadow-md h-24 sm:h-28">
                                                <div className="font-extrabold text-white text-xl">앨범</div>
                                                <div className="text-blue-100 text-xs">Gallery</div>
                                                <input type="file" accept="image/*" className="hidden" onChange={handlePhotoUpload} />
                                            </label>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="h-40 flex flex-col items-center justify-center text-gray-300 font-medium">날짜를 선택해주세요</div>
                        )}
                        </div>
                    </div>
                    )}

                    {/* 비교 모드 (이전 코드 유지) */}
                    {viewMode === 'compare' && (
                    <div className="flex flex-col min-h-full bg-gray-50 pb-10">
                        <div className="flex p-3 bg-white border-b border-gray-100 z-10 sticky top-0 shrink-0 gap-2 shadow-sm">
                        <button onClick={() => setCompareMode('gallery')} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-colors ${compareMode === 'gallery' ? 'bg-black text-white' : 'bg-gray-100 text-gray-400'}`}>슬라이드 뷰</button>
                        <button onClick={() => setCompareMode('split')} className={`flex-1 py-3 text-sm font-bold rounded-xl transition-colors ${compareMode === 'split' ? 'bg-black text-white' : 'bg-gray-100 text-gray-400'}`}>1:1 비교</button>
                        </div>
                        {Object.keys(photos).length === 0 ? (
                        <div className="flex-1 flex flex-col items-center justify-center text-gray-300 gap-4 min-h-[50vh]"><p className="font-bold">기록된 사진이 없습니다</p></div>
                        ) : (
                        <>
                            {compareMode === 'gallery' && (
                            <div 
                                ref={scrollRef}
                                className="flex-1 overflow-x-auto flex items-center gap-6 p-6 snap-x snap-mandatory scrollbar-hide bg-gray-100 h-full"
                            >
                                {gallerySortedDates.map((date) => (
                                <div key={date} className="snap-center shrink-0 w-[85vw] max-w-md h-[70vh] flex flex-col relative">
                                    <div className="flex justify-center mb-4">
                                        <span className="text-gray-500 font-extrabold text-lg tracking-wide bg-white px-4 py-1 rounded-full shadow-sm border border-gray-200">
                                            {date}
                                        </span>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] overflow-hidden flex items-center justify-center border border-gray-100">
                                        <img src={photos[date]} alt={date} className="w-full h-full object-contain" />
                                    </div>
                                </div>
                                ))}
                            </div>
                            )}
                            {compareMode === 'split' && (
                            <div className="flex flex-col gap-4 p-4">
                                <div className="flex gap-2 w-full h-[50vh] min-h-[300px]">
                                {[0, 1].map((idx) => (
                                    <div key={idx} className="flex-1 bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col relative shadow-sm">
                                    {splitSelection[idx] ? (
                                        <>
                                        <img src={photos[splitSelection[idx]]} className="w-full h-full object-contain bg-black" alt="" />
                                        <div className="absolute top-3 left-3 bg-black/70 text-white text-[10px] px-2 py-1 rounded-md font-bold">{splitSelection[idx]}</div>
                                        <button onClick={() => { const newSel = [...splitSelection]; newSel[idx] = null; setSplitSelection(newSel); }} className="absolute top-3 right-3 bg-white shadow-sm w-6 h-6 flex items-center justify-center rounded-full text-black font-bold text-xs">X</button>
                                        </>
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center text-gray-300 gap-1"><span className="text-xs font-bold text-gray-400">사진 선택 {idx + 1}</span></div>
                                    )}
                                    </div>
                                ))}
                                </div>
                                <div className="bg-white rounded-2xl border border-gray-100 p-4 flex flex-col shadow-sm">
                                <p className="text-xs text-gray-400 mb-3 font-bold px-1">비교할 사진 선택</p>
                                <div className="grid grid-cols-2 gap-3">
                                    {sortedPhotoDates.map((date) => {
                                    const isSelected = splitSelection.includes(date);
                                    return (
                                        <button key={date} disabled={isSelected} onClick={() => { const emptyIndex = splitSelection.indexOf(null); if (emptyIndex !== -1) { const newSel = [...splitSelection]; newSel[emptyIndex] = date; setSplitSelection(newSel); } else { setSplitSelection([splitSelection[1], date]); } }} className={`relative aspect-[9/16] rounded-xl overflow-hidden transition-all border bg-gray-50 group ${isSelected ? 'opacity-40 border-gray-200' : 'border-transparent hover:border-gray-300 shadow-sm'}`}>
                                            <img src={photos[date]} alt={date} className="w-full h-full object-contain" />
                                            <div className="absolute inset-x-0 bottom-0 bg-black/60 text-white text-sm font-bold py-2 text-center backdrop-blur-sm">
                                                {date}
                                            </div>
                                            {isSelected && (
                                                <div className="absolute inset-0 flex items-center justify-center bg-black/20">
                                                    <span className="bg-black text-white text-xs px-2 py-1 rounded-full">선택됨</span>
                                                </div>
                                            )}
                                        </button>
                                    );
                                    })}
                                </div>
                                </div>
                            </div>
                            )}
                        </>
                        )}
                    </div>
                    )}
                </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
